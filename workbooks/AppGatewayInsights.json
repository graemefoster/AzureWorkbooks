{
    "version": "Notebook/1.0",
    "items": [
      {
        "type": 9,
        "content": {
          "version": "KqlParameterItem/1.0",
          "parameters": [
            {
              "id": "c2e82fdb-9e42-4d71-98fa-21dc0cd7bd30",
              "version": "KqlParameterItem/1.0",
              "name": "Subscriptions",
              "type": 6,
              "multiSelect": true,
              "quote": "'",
              "delimiter": ",",
              "typeSettings": {
                "additionalResourceOptions": [],
                "includeAll": false
              },
              "timeContext": {
                "durationMs": 86400000
              },
              "value": [
                "/subscriptions/f9ca16c3-50f4-4012-a2ee-4bc1efeffbf0"
              ]
            }
          ],
          "style": "pills",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces"
        },
        "name": "parameters - 0"
      },
      {
        "type": 12,
        "content": {
          "version": "NotebookGroup/1.0",
          "groupType": "editable",
          "items": [
            {
              "type": 1,
              "content": {
                "json": "# Application Gateways\r\n\r\nApplication Gateways have internal limits related to the number of Listeners, Backend Pools, amongst others. This query shows you how far you are from exhausting some of these limits."
              },
              "name": "text - 0"
            },
            {
              "type": 3,
              "content": {
                "version": "KqlItem/1.0",
                "query": "resources\r\n| where type == \"microsoft.network/applicationgateways\"\r\n| extend\r\n    used_backend_pools = array_length(properties.backendAddressPools),\r\n    total_backend_pools = 100,\r\n    used_http_settings = array_length(properties.backendHttpSettingsCollection),\r\n    total_http_settings = 100,\r\n    used_http_listeners = array_length(properties.httpListeners),\r\n    total_http_listeners = 100\r\n| extend\r\n    remaining_backend_pools = total_backend_pools - used_backend_pools,\r\n    remaining_http_settings = total_http_settings - used_http_settings,\r\n    remaining_http_listeners = total_http_listeners - used_http_listeners\r\n| project \r\n    id, \r\n    V2 = iff(toupper(properties.sku.tier) contains \"V2\", \"✓\", \"\"),\r\n    WAF = iff(toupper(properties.sku.tier) contains \"WAF\", \"✓\", \"\"),\r\n    used_backend_pools,\r\n    used_http_settings,\r\n    used_http_listeners,\r\n    remaining_backend_pools,\r\n    remaining_http_settings,\r\n    remaining_http_listeners,\r\n    status = case(\r\n        remaining_backend_pools == 0, \"critical\", \r\n        remaining_http_settings == 0, \"critical\",\r\n        remaining_http_listeners == 0, \"critical\",\r\n        remaining_backend_pools < 10, \"warning\", \r\n        remaining_http_settings < 10, \"warning\",\r\n        remaining_http_listeners < 10, \"warning\",\r\n        remaining_backend_pools < 20, \"success\", \r\n        remaining_http_settings < 20, \"success\",\r\n        remaining_http_listeners < 20, \"success\",\r\n        \"success\")\r\n| order by status asc",
                "size": 0,
                "noDataMessage": "No application gateways found in the selected subscription",
                "queryType": 1,
                "resourceType": "microsoft.resourcegraph/resources",
                "crossComponentResources": [
                  "{Subscriptions}"
                ],
                "gridSettings": {
                  "formatters": [
                    {
                      "columnMatch": "used_backend_pools",
                      "formatter": 22,
                      "formatOptions": {
                        "compositeBarSettings": {
                          "labelText": "[\"used_backend_pools\"] / 100",
                          "columnSettings": [
                            {
                              "columnName": "used_backend_pools",
                              "color": "orange"
                            },
                            {
                              "columnName": "remaining_backend_pools",
                              "color": "blue"
                            }
                          ],
                          "noRowsScaling": true
                        }
                      }
                    },
                    {
                      "columnMatch": "used_http_settings",
                      "formatter": 22,
                      "formatOptions": {
                        "compositeBarSettings": {
                          "labelText": "[\"used_http_settings\"] / 100",
                          "columnSettings": [
                            {
                              "columnName": "used_http_settings",
                              "color": "orange"
                            },
                            {
                              "columnName": "remaining_http_settings",
                              "color": "blue"
                            }
                          ],
                          "noRowsScaling": true
                        }
                      }
                    },
                    {
                      "columnMatch": "used_http_listeners",
                      "formatter": 22,
                      "formatOptions": {
                        "compositeBarSettings": {
                          "labelText": "[\"used_http_listeners\"] / 100",
                          "columnSettings": [
                            {
                              "columnName": "used_http_listeners",
                              "color": "orange"
                            },
                            {
                              "columnName": "remaining_http_listeners",
                              "color": "blue"
                            }
                          ],
                          "noRowsScaling": true
                        }
                      }
                    },
                    {
                      "columnMatch": "remaining_backend_pools",
                      "formatter": 5,
                      "formatOptions": {
                        "compositeBarSettings": {
                          "labelText": "",
                          "columnSettings": [
                            {
                              "columnName": "used_backend_pools",
                              "color": "orange"
                            },
                            {
                              "columnName": "remaining_backend_pools",
                              "color": "blue"
                            }
                          ]
                        }
                      },
                      "numberFormat": {
                        "unit": 17,
                        "options": {
                          "style": "decimal"
                        }
                      }
                    },
                    {
                      "columnMatch": "remaining_http_settings",
                      "formatter": 5,
                      "formatOptions": {
                        "compositeBarSettings": {
                          "labelText": "",
                          "columnSettings": [
                            {
                              "columnName": "used_http_settings",
                              "color": "blue"
                            },
                            {
                              "columnName": "remaining_http_settings",
                              "color": "orange"
                            }
                          ]
                        }
                      }
                    },
                    {
                      "columnMatch": "remaining_http_listeners",
                      "formatter": 5,
                      "formatOptions": {
                        "compositeBarSettings": {
                          "labelText": "",
                          "columnSettings": [
                            {
                              "columnName": "used_http_listeners",
                              "color": "orange"
                            },
                            {
                              "columnName": "remaining_http_listeners",
                              "color": "blue"
                            }
                          ]
                        }
                      }
                    },
                    {
                      "columnMatch": "status",
                      "formatter": 11,
                      "numberFormat": {
                        "unit": 0,
                        "options": {
                          "style": "decimal"
                        }
                      }
                    }
                  ],
                  "sortBy": [
                    {
                      "itemKey": "$gen_compositeBar_used_http_listeners_5",
                      "sortOrder": 2
                    }
                  ],
                  "labelSettings": [
                    {
                      "columnId": "id",
                      "label": "Gateway"
                    },
                    {
                      "columnId": "used_backend_pools",
                      "label": "Used Backend Pools"
                    },
                    {
                      "columnId": "used_http_settings",
                      "label": "Used Http Settings"
                    },
                    {
                      "columnId": "used_http_listeners",
                      "label": "Used Http Listeners"
                    },
                    {
                      "columnId": "remaining_backend_pools",
                      "label": "Backend Pool Status"
                    },
                    {
                      "columnId": "remaining_http_settings",
                      "label": "Http Settings Status"
                    },
                    {
                      "columnId": "remaining_http_listeners",
                      "label": "Http Listeners Status"
                    },
                    {
                      "columnId": "status",
                      "label": "Status"
                    }
                  ]
                },
                "sortBy": [
                  {
                    "itemKey": "$gen_compositeBar_used_http_listeners_5",
                    "sortOrder": 2
                  }
                ]
              },
              "name": "query - 1"
            }
          ]
        },
        "name": "group - 1"
      }
    ],
    "fallbackResourceIds": [
      "Azure Monitor"
    ],
    "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
  }