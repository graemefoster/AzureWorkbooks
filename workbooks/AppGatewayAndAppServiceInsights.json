{
    "version": "Notebook/1.0",
    "items": [
      {
        "type": 9,
        "content": {
          "version": "KqlParameterItem/1.0",
          "parameters": [
            {
              "id": "0ced0017-b958-419a-9b1a-d1e90e677826",
              "version": "KqlParameterItem/1.0",
              "name": "Subscriptions",
              "type": 6,
              "multiSelect": true,
              "quote": "'",
              "delimiter": ",",
              "typeSettings": {
                "additionalResourceOptions": [],
                "includeAll": false
              },
              "timeContext": {
                "durationMs": 86400000
              },
              "value": [
              ]
            }
          ],
          "style": "pills",
          "queryType": 0,
          "resourceType": "microsoft.operationalinsights/workspaces"
        },
        "name": "parameters - 3"
      },
      {
        "type": 11,
        "content": {
          "version": "LinkItem/1.0",
          "style": "tabs",
          "links": [
            {
              "id": "9fb13347-626e-4b76-a0f1-16ac28ab3ed8",
              "cellValue": "SelectedTab",
              "linkTarget": "parameter",
              "linkLabel": "Application Gateways",
              "subTarget": "1",
              "style": "link"
            },
            {
              "id": "6519caf8-0cb9-4f19-8ec8-1167e55086a3",
              "cellValue": "SelectedTab",
              "linkTarget": "parameter",
              "linkLabel": "App Service Plans",
              "subTarget": "2",
              "style": "link"
            },
            {
              "id": "577fe92b-d1de-41f6-8c9b-5919104e4b97",
              "cellValue": "SelectedTab",
              "linkTarget": "parameter",
              "linkLabel": "App Service Environments",
              "subTarget": "3",
              "style": "link"
            }
          ]
        },
        "name": "links - 11"
      },
      {
        "type": 12,
        "content": {
          "version": "NotebookGroup/1.0",
          "groupType": "editable",
          "items": [
            {
              "type": 1,
              "content": {
                "json": "# Application Gateways\r\n\r\nApplication Gateways have internal limits related to the number of Listeners, Backend Pools, amongst others. This query shows you how far you are from exhausting some of these limits.\r\n\r\n",
                "style": "info"
              },
              "name": "text - 0"
            },
            {
              "type": 3,
              "content": {
                "version": "KqlItem/1.0",
                "query": "resources\r\n| where type == \"microsoft.network/applicationgateways\"\r\n| extend\r\n    used_backend_pools = array_length(properties.backendAddressPools),\r\n    total_backend_pools = 100,\r\n    used_http_settings = array_length(properties.backendHttpSettingsCollection),\r\n    total_http_settings = 100,\r\n    used_http_listeners = array_length(properties.httpListeners),\r\n    total_http_listeners = 100\r\n| extend\r\n    remaining_backend_pools = total_backend_pools - used_backend_pools,\r\n    remaining_http_settings = total_http_settings - used_http_settings,\r\n    remaining_http_listeners = total_http_listeners - used_http_listeners\r\n| project \r\n    id, \r\n    V2 = iff(toupper(properties.sku.tier) contains \"V2\", \"✓\", \"\"),\r\n    WAF = iff(toupper(properties.sku.tier) contains \"WAF\", \"✓\", \"\"),\r\n    used_backend_pools,\r\n    used_http_settings,\r\n    used_http_listeners,\r\n    remaining_backend_pools,\r\n    remaining_http_settings,\r\n    remaining_http_listeners,\r\n    status = case(\r\n        remaining_backend_pools == 0, 0, \r\n        remaining_http_settings == 0, 0,\r\n        remaining_http_listeners == 0, 0,\r\n        remaining_backend_pools < 10, 1, \r\n        remaining_http_settings < 10, 1,\r\n        remaining_http_listeners < 10, 1,\r\n        remaining_backend_pools < 20, 2, \r\n        remaining_http_settings < 20, 2,\r\n        remaining_http_listeners < 20, 2,\r\n        3)\r\n| order by status asc",
                "size": 0,
                "noDataMessage": "No application gateways found in the selected subscription",
                "queryType": 1,
                "resourceType": "microsoft.resourcegraph/resources",
                "crossComponentResources": [
                  "{Subscriptions}"
                ],
                "gridSettings": {
                  "formatters": [
                    {
                      "columnMatch": "used_backend_pools",
                      "formatter": 22,
                      "formatOptions": {
                        "compositeBarSettings": {
                          "labelText": "[\"used_backend_pools\"] / 100",
                          "columnSettings": [
                            {
                              "columnName": "used_backend_pools",
                              "color": "orange"
                            },
                            {
                              "columnName": "remaining_backend_pools",
                              "color": "blue"
                            }
                          ],
                          "noRowsScaling": true
                        }
                      }
                    },
                    {
                      "columnMatch": "remaining_backend_pools",
                      "formatter": 5,
                      "formatOptions": {
                        "compositeBarSettings": {
                          "labelText": "",
                          "columnSettings": [
                            {
                              "columnName": "used_backend_pools",
                              "color": "orange"
                            },
                            {
                              "columnName": "remaining_backend_pools",
                              "color": "blue"
                            }
                          ]
                        }
                      },
                      "numberFormat": {
                        "unit": 17,
                        "options": {
                          "style": "decimal"
                        }
                      }
                    },
                    {
                      "columnMatch": "used_http_settings",
                      "formatter": 22,
                      "formatOptions": {
                        "compositeBarSettings": {
                          "labelText": "[\"used_http_settings\"] / 100",
                          "columnSettings": [
                            {
                              "columnName": "used_http_settings",
                              "color": "orange"
                            },
                            {
                              "columnName": "remaining_http_settings",
                              "color": "blue"
                            }
                          ],
                          "noRowsScaling": true
                        }
                      }
                    },
                    {
                      "columnMatch": "remaining_http_settings",
                      "formatter": 5,
                      "formatOptions": {
                        "compositeBarSettings": {
                          "labelText": "",
                          "columnSettings": [
                            {
                              "columnName": "used_http_settings",
                              "color": "blue"
                            },
                            {
                              "columnName": "remaining_http_settings",
                              "color": "orange"
                            }
                          ]
                        }
                      }
                    },
                    {
                      "columnMatch": "used_http_listeners",
                      "formatter": 22,
                      "formatOptions": {
                        "compositeBarSettings": {
                          "labelText": "[\"used_http_listeners\"] / 100",
                          "columnSettings": [
                            {
                              "columnName": "used_http_listeners",
                              "color": "orange"
                            },
                            {
                              "columnName": "remaining_http_listeners",
                              "color": "blue"
                            }
                          ],
                          "noRowsScaling": true
                        }
                      }
                    },
                    {
                      "columnMatch": "remaining_http_listeners",
                      "formatter": 5,
                      "formatOptions": {
                        "compositeBarSettings": {
                          "labelText": "",
                          "columnSettings": [
                            {
                              "columnName": "used_http_listeners",
                              "color": "orange"
                            },
                            {
                              "columnName": "remaining_http_listeners",
                              "color": "blue"
                            }
                          ]
                        }
                      }
                    },
                    {
                      "columnMatch": "status",
                      "formatter": 5
                    }
                  ],
                  "sortBy": [
                    {
                      "itemKey": "$gen_compositeBar_used_http_listeners_5",
                      "sortOrder": 2
                    }
                  ]
                },
                "sortBy": [
                  {
                    "itemKey": "$gen_compositeBar_used_http_listeners_5",
                    "sortOrder": 2
                  }
                ]
              },
              "name": "query - 1"
            }
          ]
        },
        "conditionalVisibility": {
          "parameterName": "SelectedTab",
          "comparison": "isEqualTo",
          "value": "1"
        },
        "name": "ApplicationGatewayTab"
      },
      {
        "type": 12,
        "content": {
          "version": "NotebookGroup/1.0",
          "groupType": "editable",
          "items": [
            {
              "type": 1,
              "content": {
                "json": "# App Service Environments \r\n\r\nAn ASE can have a maximum of 200 instances across all of its App Service Plans. \r\nThis view shows you the total number of instances currently assigned to all the App Service Plans within an App Service Environment.\r\n\r\n",
                "style": "info"
              },
              "name": "text - 2"
            },
            {
              "type": 3,
              "content": {
                "version": "KqlItem/1.0",
                "query": "resources\r\n| where type == \"microsoft.web/hostingenvironments\"\r\n| project aseJoinid = toupper(id)\r\n| join kind=leftouter (\r\n    resources\r\n    | where type == \"microsoft.web/serverfarms\"\r\n    | project id, tier = sku.tier, capacity = sku.capacity, aseJoinId = toupper(properties.hostingEnvironmentId), aspJoinId = toupper(id)\r\n) on $left.aseJoinid == $right.aseJoinId\r\n| project aseId = aseJoinId, aspId = aspJoinId, instances = toint(capacity)\r\n| summarize aspCount = count(), totalInstances = sum(instances) by aseId\r\n| extend remaining_instances = 200 - totalInstances\r\n| order by totalInstances desc\r\n\r\n",
                "size": 1,
                "queryType": 1,
                "resourceType": "microsoft.resourcegraph/resources",
                "crossComponentResources": [
                  "{Subscriptions}"
                ],
                "gridSettings": {
                  "formatters": [
                    {
                      "columnMatch": "aspCount",
                      "formatter": 5
                    },
                    {
                      "columnMatch": "totalInstances",
                      "formatter": 22,
                      "formatOptions": {
                        "compositeBarSettings": {
                          "labelText": "[\"totalInstances\"] / 200",
                          "columnSettings": [
                            {
                              "columnName": "totalInstances",
                              "color": "orange"
                            },
                            {
                              "columnName": "remaining_instances",
                              "color": "blue"
                            }
                          ]
                        }
                      }
                    },
                    {
                      "columnMatch": "remaining_instances",
                      "formatter": 5
                    }
                  ],
                  "sortBy": [
                    {
                      "itemKey": "$gen_compositeBar_totalInstances_2",
                      "sortOrder": 1
                    }
                  ]
                },
                "sortBy": [
                  {
                    "itemKey": "$gen_compositeBar_totalInstances_2",
                    "sortOrder": 1
                  }
                ]
              },
              "name": "query - 3"
            }
          ]
        },
        "conditionalVisibility": {
          "parameterName": "SelectedTab",
          "comparison": "isEqualTo",
          "value": "3"
        },
        "name": "AppServiceEnvironment"
      },
      {
        "type": 12,
        "content": {
          "version": "NotebookGroup/1.0",
          "groupType": "editable",
          "items": [
            {
              "type": 1,
              "content": {
                "json": "# App Service Plans\r\n\r\nThis pane shows you details about the App Service Plans within an ASE.\r\nAn App Service Plan can have a maximum of 100 instances running apps within it. This view shows you\r\n - Number of instance, and Apps in each App Service Plan\r\n - The max number of instances that can still be attached to an App Service plan\r\n - The number of apps running on an App Service Plan\r\n - The number of apps over recommendation running on an App Service Plan\r\n",
                "style": "info"
              },
              "name": "text - 0"
            },
            {
              "type": 3,
              "content": {
                "version": "KqlItem/1.0",
                "query": "resources\r\n| where type == \"microsoft.web/hostingenvironments\"\r\n| project aseJoinId = toupper(id)\r\n| join kind=leftouter (\r\n    resources \r\n    | where type == \"microsoft.web/serverfarms\" \r\n    | extend aseJoinId = toupper(properties.hostingEnvironmentId)\r\n    | summarize ase_used_instances = sum(toint(sku.capacity)) by aseJoinId\r\n) on $left.aseJoinId == $right.aseJoinId\r\n| join kind=fullouter (\r\n    resources\r\n    | where type == \"microsoft.web/serverfarms\"\r\n    | project id, tier = sku.tier, size = sku.size, instances = toint(sku.capacity), aseJoinId = toupper(properties.hostingEnvironmentId), aspJoinId = toupper(id)\r\n    | project aseJoinId, aspJoinId, instances, tier, size\r\n) on $left.aseJoinId == $right.aseJoinId\r\n| join kind=leftouter (\r\n            resources         \r\n            | where type == \"microsoft.web/sites\"         \r\n            | extend aspJoinId = toupper(properties.serverFarmId)         \r\n            | summarize appCount=count(), app_ids = makeset(id) by aspJoinId \r\n) on $left.aspJoinId == $right.aspJoinId\r\n| extend \r\n    maxAppRecommendation =\r\n        case(\r\n            size == 'F1', 9999,\r\n\r\n            size == 'B1', 8,\r\n            size == 'S1', 8,\r\n            size == 'P1v2', 8,\r\n            size == 'I1', 8,\r\n\r\n            size == 'B2', 16,\r\n            size == 'S2', 16,\r\n            size == 'P2v2', 16,\r\n            size == 'I2', 16,\r\n            size == 'I1v2', 16,\r\n\r\n            size == 'B3', 32,\r\n            size == 'S3', 32,\r\n            size == 'P3v2', 32,\r\n            size == 'P2v3', 32,\r\n            size == 'I3', 32,\r\n            size == 'I2v2', 32,\r\n\r\n            size == 'P3v3', 64,\r\n            size == 'I3v2', 64,\r\n\r\n            size == 'I4v2', 128,\r\n            size == 'I5v2', 256,\r\n            size == 'I6v2', 512,\r\n            0\r\n        )\r\n| extend \r\n    remainingAppSlots = maxAppRecommendation - appCount,\r\n    used_recommended_apps = min_of(maxAppRecommendation, appCount)\r\n| extend\r\n    remaining_recommended_apps = max_of(0, remainingAppSlots),\r\n    over_recommended_apps =  -min_of(remainingAppSlots, 0)\r\n| project \r\n    aseId = aseJoinId, \r\n    aspId = aspJoinId, \r\n    instances,\r\n    remaining_possible_instances = min_of(100 - instances, (200 - ase_used_instances)),\r\n    appCount, \r\n    tier, \r\n    size, \r\n    used_recommended_apps,\r\n    remaining_recommended_apps,\r\n    over_recommended_apps,\r\n    app_ids = app_ids,\r\n    apps_label = \r\n        strcat(\r\n            tostring(used_recommended_apps), \r\n            case(remaining_recommended_apps > 0, strcat(\" (\", tostring(remaining_recommended_apps), \" remaining)\"), \"\"),\r\n            case(over_recommended_apps > 0, strcat(\" (\", tostring(over_recommended_apps), \" over)\"), \"\") \r\n        )\r\n  \r\n| order by appCount, instances desc\r\n",
                "size": 1,
                "exportedParameters": [
                  {
                    "fieldName": "aspId",
                    "parameterName": "AppServicePlan",
                    "parameterType": 1
                  },
                  {
                    "fieldName": "app_ids",
                    "parameterName": "AppServiceIds",
                    "parameterType": 5
                  },
                  {
                    "fieldName": "showAsp",
                    "parameterType": 1
                  }
                ],
                "queryType": 1,
                "resourceType": "microsoft.resourcegraph/resources",
                "crossComponentResources": [
                  "{Subscriptions}"
                ],
                "gridSettings": {
                  "formatters": [
                    {
                      "columnMatch": "instances",
                      "formatter": 22,
                      "formatOptions": {
                        "compositeBarSettings": {
                          "labelText": "[\"instances\"] / 100",
                          "columnSettings": [
                            {
                              "columnName": "instances",
                              "color": "orange"
                            },
                            {
                              "columnName": "remaining_possible_instances",
                              "color": "blue"
                            }
                          ],
                          "noRowsScaling": true
                        }
                      }
                    },
                    {
                      "columnMatch": "remaining_possible_instances",
                      "formatter": 5
                    },
                    {
                      "columnMatch": "appCount",
                      "formatter": 22,
                      "formatOptions": {
                        "compositeBarSettings": {
                          "labelText": "[\"apps_label\"]",
                          "columnSettings": [
                            {
                              "columnName": "used_recommended_apps",
                              "color": "green"
                            },
                            {
                              "columnName": "remaining_recommended_apps",
                              "color": "blue"
                            },
                            {
                              "columnName": "over_recommended_apps",
                              "color": "red"
                            }
                          ],
                          "noRowsScaling": true
                        }
                      }
                    },
                    {
                      "columnMatch": "tier",
                      "formatter": 5
                    },
                    {
                      "columnMatch": "used_recommended_apps",
                      "formatter": 5
                    },
                    {
                      "columnMatch": "remaining_recommended_apps",
                      "formatter": 5
                    },
                    {
                      "columnMatch": "over_recommended_apps",
                      "formatter": 5
                    },
                    {
                      "columnMatch": "app_ids",
                      "formatter": 5,
                      "formatOptions": {
                        "linkTarget": "WorkbookTemplate",
                        "linkLabel": "App Service Plan Usage",
                        "linkIsContextBlade": true,
                        "workbookContext": {
                          "componentIdSource": "workbook",
                          "resourceIdsSource": "workbook",
                          "templateIdSource": "static",
                          "templateId": "/",
                          "typeSource": "workbook",
                          "gallerySource": "workbook",
                          "locationSource": "default",
                          "workbookName": "App Service Plan Usage",
                          "passSpecificParams": true,
                          "templateParameters": []
                        }
                      }
                    },
                    {
                      "columnMatch": "apps_label",
                      "formatter": 5
                    }
                  ],
                  "sortBy": [
                    {
                      "itemKey": "$gen_compositeBar_appCount_4",
                      "sortOrder": 1
                    }
                  ]
                },
                "sortBy": [
                  {
                    "itemKey": "$gen_compositeBar_appCount_4",
                    "sortOrder": 1
                  }
                ]
              },
              "name": "query - 1"
            },
            {
              "type": 10,
              "content": {
                "chartId": "workbook3552ec3b-7092-473b-bb3e-2c2e16ed2f96",
                "version": "MetricsItem/2.0",
                "size": 1,
                "chartType": 2,
                "resourceType": "microsoft.web/serverfarms",
                "metricScope": 0,
                "resourceParameter": "AppServicePlan",
                "resourceIds": [
                  "{AppServicePlan}"
                ],
                "timeContext": {
                  "durationMs": 604800000
                },
                "metrics": [
                  {
                    "namespace": "microsoft.web/serverfarms",
                    "metric": "microsoft.web/serverfarms--CpuPercentage",
                    "aggregation": 4,
                    "splitBy": null
                  },
                  {
                    "namespace": "microsoft.web/serverfarms",
                    "metric": "microsoft.web/serverfarms--MemoryPercentage",
                    "aggregation": 4
                  }
                ],
                "gridSettings": {
                  "rowLimit": 10000
                }
              },
              "name": "metric - 1"
            },
            {
              "type": 12,
              "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                  {
                    "type": 1,
                    "content": {
                      "json": "# Apps inside App service plan\r\n\r\nAn App Service Plan can host many apps. This view shows you the CPU Time, and Private bytes used by the individual apps.\r\n\r\nHosting too many apps in an App Service plan can cause noisy neighbour syndrome, where the demands of one app have adverse effects on others.\r\n\r\nKnowing the RAM / CPU time of each apps will help you to move apps into different App Service plans appropriately."
                    },
                    "name": "text - 5"
                  },
                  {
                    "type": 11,
                    "content": {
                      "version": "LinkItem/1.0",
                      "style": "tabs",
                      "links": [
                        {
                          "id": "edc9e420-16db-4a88-9d15-b1f25c58a4b8",
                          "cellValue": "AppSelectedTab",
                          "linkTarget": "parameter",
                          "linkLabel": "Cpu Time By Application",
                          "subTarget": "1",
                          "preText": "",
                          "style": "link"
                        },
                        {
                          "id": "f9d4196f-d2fd-4c1a-aaf5-e5900f8b52b4",
                          "cellValue": "AppSelectedTab",
                          "linkTarget": "parameter",
                          "linkLabel": "Private Bytes By Application",
                          "subTarget": "2",
                          "style": "link"
                        },
                        {
                          "id": "8d56f41a-268e-4d6d-8dee-45d117668e07",
                          "cellValue": "AppSelectedTab",
                          "linkTarget": "parameter",
                          "linkLabel": "Requests By Application",
                          "subTarget": "3",
                          "style": "link"
                        }
                      ]
                    },
                    "name": "links - 6"
                  },
                  {
                    "type": 12,
                    "content": {
                      "version": "NotebookGroup/1.0",
                      "groupType": "editable",
                      "items": [
                        {
                          "type": 1,
                          "content": {
                            "json": "## CPU Time by App "
                          },
                          "name": "text - 6"
                        },
                        {
                          "type": 10,
                          "content": {
                            "chartId": "workbook8d7870a8-9f53-486c-8f11-270d78c3bc8f",
                            "version": "MetricsItem/2.0",
                            "size": 0,
                            "chartType": 2,
                            "resourceType": "microsoft.web/sites",
                            "metricScope": 0,
                            "resourceParameter": "AppServiceIds",
                            "resourceIds": [
                              "{AppServiceIds}"
                            ],
                            "timeContext": {
                              "durationMs": 604800000
                            },
                            "metrics": [
                              {
                                "namespace": "microsoft.web/sites",
                                "metric": "microsoft.web/sites--CpuTime",
                                "aggregation": 1,
                                "splitBy": null
                              }
                            ],
                            "gridSettings": {
                              "rowLimit": 10000
                            }
                          },
                          "name": "metric - 5"
                        }
                      ]
                    },
                    "conditionalVisibility": {
                      "parameterName": "AppSelectedTab",
                      "comparison": "isEqualTo",
                      "value": "1"
                    },
                    "name": "CpuTimeByApp"
                  },
                  {
                    "type": 12,
                    "content": {
                      "version": "NotebookGroup/1.0",
                      "groupType": "editable",
                      "items": [
                        {
                          "type": 1,
                          "content": {
                            "json": "## Private Bytes by App"
                          },
                          "name": "text - 7"
                        },
                        {
                          "type": 10,
                          "content": {
                            "chartId": "workbook8d7870a8-9f53-486c-8f11-270d78c3bc8f",
                            "version": "MetricsItem/2.0",
                            "size": 0,
                            "chartType": 2,
                            "resourceType": "microsoft.web/sites",
                            "metricScope": 0,
                            "resourceParameter": "AppServiceIds",
                            "resourceIds": [
                              "{AppServiceIds}"
                            ],
                            "timeContext": {
                              "durationMs": 604800000
                            },
                            "metrics": [
                              {
                                "namespace": "microsoft.web/sites",
                                "metric": "microsoft.web/sites--PrivateBytes",
                                "aggregation": 4,
                                "splitBy": null
                              }
                            ],
                            "gridSettings": {
                              "rowLimit": 10000
                            }
                          },
                          "name": "metric - 5 - Copy"
                        }
                      ]
                    },
                    "conditionalVisibility": {
                      "parameterName": "AppSelectedTab",
                      "comparison": "isEqualTo",
                      "value": "2"
                    },
                    "name": "PrivateBytesByApp"
                  },
                  {
                    "type": 12,
                    "content": {
                      "version": "NotebookGroup/1.0",
                      "groupType": "editable",
                      "items": [
                        {
                          "type": 1,
                          "content": {
                            "json": "## Requests by App"
                          },
                          "name": "text - 9"
                        },
                        {
                          "type": 10,
                          "content": {
                            "chartId": "workbooke4de478c-6d77-4f44-be4b-53e583515219",
                            "version": "MetricsItem/2.0",
                            "size": 0,
                            "chartType": 2,
                            "resourceType": "microsoft.web/sites",
                            "metricScope": 0,
                            "resourceParameter": "AppServiceIds",
                            "resourceIds": [
                              "{AppServiceIds}"
                            ],
                            "timeContext": {
                              "durationMs": 604800000
                            },
                            "metrics": [
                              {
                                "namespace": "microsoft.web/sites",
                                "metric": "microsoft.web/sites--Requests",
                                "aggregation": 1,
                                "splitBy": null
                              }
                            ],
                            "gridSettings": {
                              "rowLimit": 10000
                            }
                          },
                          "name": "metric - 9"
                        }
                      ]
                    },
                    "conditionalVisibility": {
                      "parameterName": "AppSelectedTab",
                      "comparison": "isEqualTo",
                      "value": "3"
                    },
                    "name": "RequestsByApp"
                  }
                ]
              },
              "conditionalVisibilities": [
                {
                  "parameterName": "SelectedTab",
                  "comparison": "isEqualTo",
                  "value": "2"
                },
                {
                  "parameterName": "AppServicePlan",
                  "comparison": "isNotEqualTo",
                  "value": ""
                }
              ],
              "name": "SelectedAppServicePlan"
            }
          ],
          "exportParameters": true
        },
        "conditionalVisibility": {
          "parameterName": "SelectedTab",
          "comparison": "isEqualTo",
          "value": "2"
        },
        "name": "AppServicePlans"
      }
    ],
    "fallbackResourceIds": [
      "azure monitor"
    ],
    "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
  }